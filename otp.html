<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify - Aviator Genius</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #007bff; --bg: #0a0e17; --accent: #ffcc00; }
        body { background: var(--bg); color: white; font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; overflow: hidden; }
        .card { background: rgba(255,255,255,0.05); padding: 30px; border-radius: 20px; width: 85%; max-width: 380px; border: 1px solid var(--primary); text-align: center; backdrop-filter: blur(10px); }
        
        h3 { margin-bottom: 10px; }
        p { font-size: 0.85rem; opacity: 0.7; line-height: 1.4; margin-bottom: 20px; }
        
        input { 
            width: 100%; padding: 15px; margin-bottom: 20px; border-radius: 10px; 
            border: 2px solid rgba(255,255,255,0.1); text-align: center; font-size: 1.8rem; letter-spacing: 8px; 
            font-weight: bold; background: white; color: black; box-sizing: border-box;
        }
        
        button { 
            width: 100%; padding: 14px; background: var(--primary); color: white; 
            border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 1rem;
        }
        button:disabled { opacity: 0.5; }

        .resend-container { margin-top: 20px; font-size: 0.85rem; }
        .resend-link { color: var(--primary); cursor: pointer; text-decoration: underline; display: none; }
        .timer-display { color: #888; cursor: not-allowed; }

        .status-msg { margin-top: 15px; font-size: 0.8rem; padding: 10px; border-radius: 8px; background: rgba(255,255,255,0.05); color: var(--accent); font-weight: bold; }

        #toast { 
            position: fixed; top: 30px; left: 50%; transform: translateX(-50%) scale(0.5); 
            padding: 15px 30px; border-radius: 50px; display: none; z-index: 9999; 
            color: white; font-weight: bold; box-shadow: 0 8px 25px rgba(0,0,0,0.4); opacity: 0; 
        }
        .animate { display: block !important; animation: bounceIn 0.6s forwards; }
        @keyframes bounceIn { 0% { transform: translateX(-50%) scale(0.3); opacity: 0; } 100% { transform: translateX(-50%) scale(1); opacity: 1; } }
    </style>
</head>
<body>

    <div id="toast"></div>

    <div class="card">
        <h3>Verify Identity</h3>
        <p>Enter the 5-digit verification code provided.</p>
        
        <input type="number" id="otp-input" placeholder="00000" oninput="if(this.value.length > 5) this.value = this.value.slice(0, 5)">
        
        <button id="verify-btn" onclick="handleVerify()">Verify & Join</button>
        
        <div id="status-indicator" class="status-msg">Connecting...</div>

        <div class="resend-container">
            <span id="resend-timer-text" class="timer-display">Resend available in <b id="timer">03:00</b></span>
            <span id="resend-link" class="resend-link" onclick="requestNewCode()">Request New Code</span>
        </div>
    </div>

    <script>
        var _supa;
        var myEmail = localStorage.getItem('my_email');
        var countdown;

        window.onload = function() {
            _supa = getClient();
            if (!myEmail) {
                location.href='signup.html';
                return;
            }
            startTimer(180); // Start 3 minute timer
            checkLiveStatus();
            setInterval(checkLiveStatus, 5000); 
        };

        function startTimer(seconds) {
            clearInterval(countdown);
            const display = document.querySelector('#timer');
            const timerText = document.querySelector('#resend-timer-text');
            const resendLink = document.querySelector('#resend-link');
            
            resendLink.style.display = "none";
            timerText.style.display = "inline";

            let timer = seconds;
            countdown = setInterval(function () {
                let minutes = parseInt(timer / 60, 10);
                let secs = parseInt(timer % 60, 10);

                minutes = minutes < 10 ? "0" + minutes : minutes;
                secs = secs < 10 ? "0" + secs : secs;

                display.textContent = minutes + ":" + secs;

                if (--timer < 0) {
                    clearInterval(countdown);
                    timerText.style.display = "none";
                    resendLink.style.display = "inline";
                }
            }, 1000);
        }

        async function checkLiveStatus() {
            const { data } = await _supa.from('profiles').select('otp_status').eq('email', myEmail).single();
            const indicator = document.getElementById('status-indicator');
            
            if (data.otp_status === 'PENDING') {
                indicator.innerHTML = "Status: Code Sent! Check your mail.";
                indicator.style.color = "#2ecc71";
            } else if (data.otp_status === 'RESEND_REQUESTED') {
                indicator.innerHTML = "Status: Admin is generating new code...";
                indicator.style.color = "#ffcc00";
            } else if (data.otp_status === 'VERIFIED') {
                indicator.innerHTML = "Status: Verified! Redirecting...";
                indicator.style.color = "#2ecc71";
            } else {
                indicator.innerHTML = "Status: Waiting for new code...";
            }
        }

        async function requestNewCode() {
            const { error } = await _supa.from('profiles').update({ 
                otp_code: null, 
                otp_status: 'RESEND_REQUESTED' 
            }).eq('email', myEmail);

            if (!error) {
                showToast("Request sent", true);
                document.getElementById('otp-input').value = "";
                startTimer(180); // Restart 3-min timer after requesting
            }
        }

        function showToast(msg, isSuccess) {
            var t = document.getElementById('toast');
            t.innerText = msg;
            t.style.background = isSuccess ? "#2ecc71" : "#ff4d4d";
            t.className = "animate";
            setTimeout(function(){ t.className = ""; t.style.display="none"; }, 3000);
        }

        async function handleVerify() {
            var inputVal = document.getElementById('otp-input').value;
            var btn = document.getElementById('verify-btn');

            if (inputVal.length < 5) {
                showToast("Enter 5-digit code", false);
                return;
            }

            btn.innerText = "Verifying...";
            btn.disabled = true;

            const { data } = await _supa.from('profiles').select('otp_code').eq('email', myEmail).single();

            if (data && data.otp_code === inputVal) {
                await _supa.from('profiles').update({ otp_status: 'VERIFIED' }).eq('email', myEmail);
                showToast("Verification Successful!", true);
                localStorage.setItem('is_verified', 'true');
                setTimeout(function(){ location.href='login.html'; }, 2000);
            } else {
                showToast("Invalid Code.", false);
                btn.innerText = "Verify & Join";
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
