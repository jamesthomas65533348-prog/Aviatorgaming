<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aviator Genius - Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="config.js"></script>
    
    <style>
        :root { --primary: #ff0044; --bg: #050a14; --success: #2ecc71; --gold: #ffcc00; --card: #111827; --error: #e74c3c; --info: #3498db; }
        body { background: var(--bg); color: white; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; overflow-x: hidden; }

        /* Toasts */
        #win-toast, #error-toast, #info-toast { 
            position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%) scale(0); 
            padding: 25px 40px; border-radius: 25px; text-align: center; z-index: 3000; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            min-width: 250px;
        }
        #win-toast { background: linear-gradient(145deg, #0a2e1a, #000); border: 2px solid var(--success); box-shadow: 0 0 30px rgba(46, 204, 113, 0.3); }
        #error-toast { background: linear-gradient(145deg, #2e0a0a, #000); border: 2px solid var(--error); box-shadow: 0 0 30px rgba(231, 76, 60, 0.3); }
        #info-toast { background: linear-gradient(145deg, #0a1a2e, #000); border: 2px solid var(--info); box-shadow: 0 0 30px rgba(52, 152, 219, 0.3); }
        .show-toast { transform: translate(-50%, -50%) scale(1) !important; }

        /* Security Modal */
        #security-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 4000; }
        .modal-card { background: #111827; border: 1px solid var(--primary); padding: 30px; border-radius: 20px; width: 85%; max-width: 400px; text-align: center; }
        .modal-btn { width: 100%; padding: 15px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; margin-top: 15px; }

        /* Header & Nav */
        .top-nav { display: flex; align-items: center; padding: 10px 15px; background: #000; border-bottom: 1px solid #222; justify-content: space-between; }
        .back-btn { background: #222; border: none; color: white; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: 0.8rem; font-weight: bold; text-decoration: none; }
        .vol-btn { background: none; border: none; color: #666; font-size: 1.2rem; cursor: pointer; padding: 5px 10px; }
        .vol-btn.active { color: var(--success); }

        .history-bar { display: flex; gap: 8px; padding: 10px; background: #000; overflow-x: auto; scrollbar-width: none; align-items: center; }
        .hist-bubble { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; background: #1a1a1a; border: 1px solid #333; flex-shrink: 0; }
        
        /* Game Screen */
        .game-screen { 
            height: 260px; position: relative; background: #050a14;
            background-image: radial-gradient(at 0% 100%, rgba(255, 0, 68, 0.15) 0px, transparent 50%), radial-gradient(at 100% 0%, rgba(52, 152, 219, 0.1) 0px, transparent 50%), radial-gradient(at 50% 50%, rgba(26, 42, 68, 0.4) 0px, transparent 80%);
            overflow: hidden; display: flex; justify-content: center; align-items: center; animation: bg-glow 8s ease-in-out infinite alternate;
        }
        @keyframes bg-glow { 0% { background-color: #050a14; } 100% { background-color: #0a1122; } }
        
        #plane-wrapper { position: absolute; bottom: 30px; left: 30px; width: 100px; height: 60px; z-index: 50; display: none; transition: transform 0.2s linear; filter: drop-shadow(0 0 10px rgba(255, 0, 68, 0.5)); }
        .plane-svg { width: 100%; height: 100%; transform: rotate(-5deg); }
        .floating { animation: float 2s ease-in-out infinite; }
        @keyframes float { 0%, 100% { margin-bottom: 0px; } 50% { margin-bottom: 15px; } }

        .multiplier { font-size: 4.5rem; font-weight: 900; z-index: 10; text-shadow: 0 0 20px rgba(0,0,0,0.5); position: relative; }
        .crashed { color: var(--primary) !important; }

        #countdown-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.8); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 60; }
        .progress-container { width: 70%; height: 12px; background: #1a1f2e; border-radius: 10px; overflow: hidden; border: 1px solid #333; margin-top: 15px; }
        .progress-fill { width: 100%; height: 100%; background: linear-gradient(90deg, #ff0044, #ff5588); transition: width 1s linear; }
        .timer-text { font-size: 1.2rem; font-weight: 900; color: white; letter-spacing: 2px; }

        .player-list { padding: 15px; background: var(--card); min-height: 100vh; padding-bottom: 350px; }
        .list-info { display: flex; justify-content: space-between; padding: 10px; color: #555; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; border-bottom: 1px solid #222; }
        .player-row { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #1f2937; font-size: 0.8rem; }
        .player-row.won { background: rgba(46, 204, 113, 0.15); color: var(--success); font-weight: bold; }

        /* Footer & Auto Controls */
        .controls-footer { position: fixed; bottom: 0; width: 100%; background: #0b0f1a; padding: 15px 20px; border-top: 1px solid #333; box-sizing: border-box; z-index: 1100; }
        .auto-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding: 5px 0; }
        
        .switch { position: relative; display: inline-block; width: 44px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background-color: #333; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(22px); }

        .auto-input-container { display: none; align-items: center; background: #1a1f2e; border-radius: 8px; padding: 2px 8px; border: 1px solid #333; }
        .auto-input-container input { background: none; border: none; color: var(--gold); width: 60px; text-align: center; font-weight: bold; font-size: 0.9rem; pointer-events: none; }

        .btn-main { width: 100%; padding: 18px; border-radius: 12px; border: none; font-size: 1.2rem; font-weight: 900; cursor: pointer; text-transform: uppercase; }
        .btn-bet { background: var(--success); color: #000; }
        .btn-cash { background: var(--gold); color: #000; }

        /* Custom Keypad */
        #custom-keypad { position: fixed; bottom: -100%; left: 0; width: 100%; background: #111827; transition: 0.3s; z-index: 5000; border-top: 2px solid var(--primary); padding-bottom: 20px; }
        .keypad-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 15px; }
        .key { background: #1f2937; padding: 15px; border-radius: 10px; text-align: center; font-size: 1.5rem; font-weight: bold; cursor: pointer; }
        .key:active { background: var(--primary); }
    </style>
</head>
<body>

<audio id="snd-countdown" src="assets/sounds/countdown.mp3" preload="auto"></audio>
<audio id="snd-flying" src="assets/sounds/flying.mp3" loop preload="auto"></audio>
<audio id="snd-crash" src="assets/sounds/crash.mp3" preload="auto"></audio>

<div id="security-modal">
    <div class="modal-card">
        <h2 style="margin:0 0 10px 0; color: #fff;">Safety Warning</h2>
        <p style="font-size: 0.9rem; color: #94a3b8; line-height: 1.5;">Minimum bet is 500,000 but please for security and funds safe keeping don't bet exactly 500,000 for a round cause it might lead to fund hanging.</p>
        <button class="modal-btn" style="background: var(--primary); color: white;" onclick="closeSecurityModal(false)">I UNDERSTAND</button>
        <button class="modal-btn" style="background: transparent; color: #64748b; font-size: 0.8rem;" onclick="closeSecurityModal(true)">DON'T SHOW THIS AGAIN</button>
    </div>
</div>

<div id="custom-keypad">
    <div style="display:flex; justify-content: space-between; padding: 10px 15px; border-bottom: 1px solid #333;">
        <span style="font-size:0.8rem; color:#666;">SET AUTO CASH OUT</span>
        <span onclick="closeKeypad()" style="color:var(--primary); font-weight:bold;">DONE</span>
    </div>
    <div class="keypad-grid">
        <div class="key" onclick="kpIn('1')">1</div><div class="key" onclick="kpIn('2')">2</div><div class="key" onclick="kpIn('3')">3</div>
        <div class="key" onclick="kpIn('4')">4</div><div class="key" onclick="kpIn('5')">5</div><div class="key" onclick="kpIn('6')">6</div>
        <div class="key" onclick="kpIn('7')">7</div><div class="key" onclick="kpIn('8')">8</div><div class="key" onclick="kpIn('9')">9</div>
        <div class="key" onclick="kpIn('.')">.</div><div class="key" onclick="kpIn('0')">0</div><div class="key" onclick="kpDel()"><i class="fa-solid fa-backspace"></i></div>
    </div>
</div>

<div id="win-toast"><div style="font-size:0.8rem; color:var(--success); font-weight:bold;">CASHOUT SUCCESS</div><h1 id="toast-mult" style="margin:0; font-size:2.5rem;">2.50x</h1><h2 id="toast-amt" style="margin:5px 0;">₦0.00</h2></div>
<div id="error-toast"><div id="error-msg" style="font-weight:bold;">Insufficient Balance</div></div>
<div id="info-toast"><div style="font-size:0.9rem; color:var(--info); font-weight:bold; text-transform:uppercase;">Round in Progress</div><div style="font-size:0.8rem; color:#fff; margin-top:5px;">Set your price to bet and wait for the countdown</div></div>

<div class="game-container">
    <div class="sticky-header">
        <div class="top-nav">
            <a href="home.html" class="back-btn">⬅ BACK</a>
            <span style="font-weight: 900; font-size: 0.9rem; color: var(--primary);">AVIATOR GENIUS</span>
            <button id="mute-toggle" class="vol-btn active" onclick="toggleMute()"><i class="fa-solid fa-volume-high"></i></button>
        </div>
        <div class="history-bar" id="history-container"></div>
        <div class="game-screen">
            <div id="countdown-overlay">
                <div class="timer-text">NEXT ROUND IN <span id="timer-sec">5</span>s</div>
                <div class="progress-container"><div class="progress-fill" id="progress-bar"></div></div>
            </div>
            <div id="multiplier" class="multiplier">1.00x</div>
            <div id="plane-wrapper">
                <svg class="plane-svg" viewBox="0 0 120 60">
                    <defs><linearGradient id="planeGrad" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" style="stop-color:#990022" /><stop offset="100%" style="stop-color:#ff0044" /></linearGradient></defs>
                    <path d="M15,30 L5,10 L5,50 Z" fill="url(#planeGrad)" /><path d="M10,30 Q10,10 60,10 L100,25 Q115,30 100,35 L60,50 Q10,50 10,30" fill="url(#planeGrad)" />
                    <circle cx="108" cy="30" r="4" fill="#fff"><animate attributeName="opacity" values="1;0.3;1" dur="0.1s" repeatCount="indefinite" /></circle>
                </svg>
            </div>
        </div>
    </div>

    <div class="list-info"><span>All Bets</span><span>Live Users: <span id="bot-count" style="color:var(--success)">0</span></span></div>
    <div class="player-list" id="player-list"></div>

    <div class="controls-footer">
        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.8rem;">
            <span>WALLET: <span id="bal-display" style="color: var(--success); font-weight: bold;">0.00</span></span>
            <div class="auto-row">
                <span style="font-size:0.7rem; color:#888;">AUTO CASH OUT</span>
                <label class="switch">
                    <input type="checkbox" id="auto-toggle" onchange="toggleAutoUI()">
                    <span class="slider"></span>
                </label>
                <div id="auto-input-box" class="auto-input-container" onclick="openKeypad()">
                    <input type="text" id="auto-val" value="2.00" readonly>
                    <span style="color:#666; font-size:0.7rem;">x</span>
                </div>
            </div>
        </div>
        <div style="display:flex; gap:10px; margin-bottom: 12px;">
             <button class="btn-adjust" onclick="adjustBet(-50)" style="background:#2d3548; border:none; color:white; width:45px; border-radius:8px;">-</button>
             <input type="number" id="bet-amt" value="100" style="flex:1; background:#1a1f2e; border:1px solid #333; color:white; text-align:center; font-weight:bold; border-radius:10px; font-size: 1.1rem;">
             <button class="btn-adjust" onclick="adjustBet(50)" style="background:#2d3548; border:none; color:white; width:45px; border-radius:8px;">+</button>
        </div>
        <button id="action-btn" class="btn-main btn-bet" onclick="handleMainAction()">Place Bet</button>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://aviatorlife-54828-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const gameRef = firebase.database().ref("live_game");

    let _supa, myEmail = localStorage.getItem('user_email'), balance = 0;
    let currentMult = 1.0, gameActive = false, isQueued = false, hasCashedOut = false;
    let lockedBet = 0, bots = [], gameActive_Triggered = false; 
    let autoCashEnabled = false, autoCashValue = 2.00;

    const sCountdown = document.getElementById('snd-countdown');
    const sFlying = document.getElementById('snd-flying');
    const sCrash = document.getElementById('snd-crash');
    let masterMute = false;

    window.onload = async () => {
        _supa = getClient();
        await fetchUserData();
        loadHistory();
        initFirebaseSync(); 
    };

    function toggleAutoUI() {
        autoCashEnabled = document.getElementById('auto-toggle').checked;
        document.getElementById('auto-input-box').style.display = autoCashEnabled ? 'flex' : 'none';
        if(!autoCashEnabled) closeKeypad();
    }

    function openKeypad() { document.getElementById('custom-keypad').style.bottom = '0'; }
    function closeKeypad() { document.getElementById('custom-keypad').style.bottom = '-100%'; }
    
    function kpIn(val) {
        let input = document.getElementById('auto-val');
        if(val === '.' && input.value.includes('.')) return;
        if(input.value === '0') input.value = val;
        else input.value += val;
        autoCashValue = parseFloat(input.value) || 0;
    }
    
    function kpDel() {
        let input = document.getElementById('auto-val');
        input.value = input.value.slice(0, -1);
        autoCashValue = parseFloat(input.value) || 0;
    }

    function initFirebaseSync() {
        gameRef.on("value", (snapshot) => {
            const data = snapshot.val();
            if(!data) return;
            currentMult = parseFloat(data.multiplier);
            if(data.status === "WAITING") handleWaitingState(data.countdown);
            else if (data.status === "FLYING") handleFlyingState(data.multiplier);
            else if (data.status === "CRASHED") handleCrashedState();
        });
    }

    function handleWaitingState(timer) {
        gameActive = false; hasCashedOut = false;
        document.getElementById('multiplier').classList.remove('crashed');
        document.getElementById('countdown-overlay').style.display = 'flex';
        document.getElementById('timer-sec').innerText = timer;
        sFlying.pause(); sFlying.currentTime = 0;
        if(timer === 5 && !masterMute) sCountdown.play().catch(e => {});
        document.getElementById('progress-bar').style.width = (timer / 5 * 100) + "%";
        document.getElementById('plane-wrapper').style.display = "none";
        if(bots.length === 0) generateBots(); 
        updateBtnUI();
    }

    async function handleFlyingState(mult) {
        gameActive = true;
        document.getElementById('countdown-overlay').style.display = 'none';
        document.getElementById('multiplier').innerText = mult + "x";
        
        // AUTO CASH OUT LOGIC
        if(isQueued && !hasCashedOut && autoCashEnabled && currentMult >= autoCashValue) {
            cashOut();
        }

        // BOT CASH OUT LOGIC
        let botWinDetected = false;
        bots.forEach(b => {
            if(!b.won && currentMult >= parseFloat(b.cashAt)) {
                b.won = true;
                botWinDetected = true;
            }
        });
        if(botWinDetected) renderPlayers();

        const plane = document.getElementById('plane-wrapper');
        plane.style.display = "block";
        if(sFlying.paused && !masterMute) { sFlying.volume = 0.5; sFlying.play().catch(e => {}); }

        if(isQueued && !gameActive_Triggered) await deductBalance(lockedBet);
        if(isQueued && !hasCashedOut) {
            document.getElementById('action-btn').innerText = `CASH OUT ₦${(lockedBet * currentMult).toFixed(2)}`;
            document.getElementById('action-btn').className = "btn-main btn-cash";
        }

        let progress = Math.min((currentMult - 1) / 15, 1);
        plane.style.transform = `translate(${progress * 240}px, ${progress * -140}px) scale(${1 + (progress * 0.3)})`;
        if (currentMult >= 2.0) plane.classList.add('floating');
    }

    async function cashOut() {
        if(hasCashedOut || !isQueued || !gameActive) return;
        hasCashedOut = true;
        const win = lockedBet * currentMult;
        balance += win; updateBalanceUI();
        document.getElementById('toast-mult').innerText = currentMult.toFixed(2) + "x";
        document.getElementById('toast-amt').innerText = "₦" + win.toLocaleString();
        document.getElementById('win-toast').classList.add('show-toast');
        document.getElementById('action-btn').innerText = "SUCCESS";
        document.getElementById('action-btn').className = "btn-main btn-waiting";
        await _supa.from('profiles').update({ balance }).eq('email', myEmail);
        setTimeout(() => document.getElementById('win-toast').classList.remove('show-toast'), 2500);
    }

    function handleMainAction() {
        if (gameActive && !isQueued) {
            document.getElementById('info-toast').classList.add('show-toast');
            setTimeout(() => document.getElementById('info-toast').classList.remove('show-toast'), 3000);
            return;
        }

        const betAmt = Number(document.getElementById('bet-amt').value);
        if (betAmt < 100) { showError("Min Bet is ₦100"); return; }
        
        const warningHidden = localStorage.getItem('hide_security_warning') === 'true';
        if (betAmt > 500000) { showError("Maximum bet is 500,000"); return; }
        if (betAmt === 500000 && !warningHidden) {
            document.getElementById('security-modal').style.display = 'flex';
            return;
        }

        if(!gameActive) {
            if(!isQueued) {
                if(balance < betAmt) { showError("Insufficient Balance"); return; }
                lockedBet = betAmt; isQueued = true; toggleControls(false); 
            } else { isQueued = false; lockedBet = 0; toggleControls(true); }
            updateBtnUI();
        } else if(!hasCashedOut && isQueued) cashOut();
    }

    async function deductBalance(amt) {
        gameActive_Triggered = true; balance -= amt; updateBalanceUI();
        await _supa.from('profiles').update({ balance }).eq('email', myEmail);
    }

    function handleCrashedState() {
        gameActive = false; gameActive_Triggered = false;
        sFlying.pause(); if(!masterMute) sCrash.play().catch(e => {});
        document.getElementById('multiplier').innerText = "FLEW AWAY";
        document.getElementById('multiplier').classList.add('crashed');
        setTimeout(() => { document.getElementById('plane-wrapper').style.display = "none"; }, 100);
        isQueued = false; lockedBet = 0; toggleControls(true); updateBtnUI(); loadHistory(); bots = []; 
    }

    async function fetchUserData() {
        if(!myEmail) return;
        const { data } = await _supa.from('profiles').select('balance').eq('email', myEmail.toLowerCase().trim()).maybeSingle();
        if(data) { balance = Number(data.balance); updateBalanceUI(); }
    }

    function updateBalanceUI() { document.getElementById('bal-display').innerText = balance.toLocaleString(undefined, {minimumFractionDigits: 2}); }
    function toggleControls(enable) { document.querySelectorAll('.btn-adjust, #bet-amt').forEach(el => el.disabled = !enable); }
    function updateBtnUI() {
        const btn = document.getElementById('action-btn');
        if(!gameActive) {
            btn.innerText = isQueued ? "CANCEL QUEUE" : "PLACE BET";
            btn.style.background = isQueued ? "#550011" : "var(--success)";
        }
    }
    function showError(msg) {
        document.getElementById('error-msg').innerText = msg;
        document.getElementById('error-toast').classList.add('show-toast');
        setTimeout(() => document.getElementById('error-toast').classList.remove('show-toast'), 3000);
    }
    function adjustBet(val) {
        let input = document.getElementById('bet-amt');
        input.value = Math.max(100, Number(input.value) + val);
    }
    async function loadHistory() {
        try {
            const { data } = await _supa.from('game_logs').select('multiplier_cashed').order('created_at', {ascending: false}).limit(10);
            if(data) document.getElementById('history-container').innerHTML = data.map(h => `<div class="hist-bubble">${Number(h.multiplier_cashed).toFixed(2)}x</div>`).join('');
        } catch(e) {}
    }
    function generateBots() {
        const count = Math.floor(Math.random() * 200) + 100;
        bots = Array.from({length: count}, () => ({
            id: `ID_${Math.floor(100 + Math.random() * 899)}***`,
            bet: Math.floor(Math.random() * (500000 - 1000 + 1)) + 1000,
            cashAt: (1.1 + Math.random() * 4).toFixed(2),
            won: false
        })).sort((a,b) => b.bet - a.bet);
        document.getElementById('bot-count').innerText = bots.length;
        renderPlayers();
    }
    function renderPlayers() {
        document.getElementById('player-list').innerHTML = bots.slice(0, 25).map(b => `
            <div class="player-row ${b.won ? 'won' : ''}">
                <div><span style="color:#666; font-size:0.7rem;">${b.id}</span><br>₦${b.bet.toLocaleString()}</div>
                <div style="text-align:right">${b.won ? `<span style="font-size:0.7rem;">${b.cashAt}x</span><br>₦${(b.bet*b.cashAt).toLocaleString()}` : '•••'}</div>
            </div>`).join('');
    }
    
    function toggleMute() {
        masterMute = !masterMute;
        const btn = document.getElementById('mute-toggle');
        btn.innerHTML = masterMute ? '<i class="fa-solid fa-volume-xmark"></i>' : '<i class="fa-solid fa-volume-high"></i>';
        btn.classList.toggle('active', !masterMute);
        const audios = [sCountdown, sFlying, sCrash];
        audios.forEach(audio => { audio.muted = masterMute; });
        if (masterMute) { sFlying.pause(); } else if (gameActive) { sFlying.play().catch(e => {}); }
    }

    function closeSecurityModal(permanently) {
        if(permanently) localStorage.setItem('hide_security_warning', 'true');
        document.getElementById('security-modal').style.display = 'none';
    }
</script>
</body>
</html>
