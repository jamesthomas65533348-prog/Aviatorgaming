<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aviator Genius - Elite Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="config.js"></script>
    
    <style>
        :root { 
            --primary: #ff0044; 
            --bg: #030712; 
            --success: #2ecc71; 
            --gold: #ffcc00; 
            --card: #0f172a; 
            --error: #ef4444; 
            --info: #3498db;
        }
        
        body { background: var(--bg); color: white; font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; overflow-x: hidden; user-select: none; }

        /* --- ADVANCED COUNTDOWN --- */
        #countdown-overlay { 
            position: absolute; inset: 0; background: rgba(3, 7, 18, 0.9); 
            display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100;
        }
        .launch-ring {
            width: 100px; height: 100px; border-radius: 50%;
            border: 4px solid #1e293b; border-top-color: var(--primary);
            display: flex; justify-content: center; align-items: center;
            animation: spin 1s linear infinite; position: relative;
        }
        .timer-val { position: absolute; font-size: 2.2rem; font-weight: 900; animation: none; color: white; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- MODERN SIDE-VIEW JET --- */
        #plane-wrapper { 
            position: absolute; bottom: 30px; left: 30px; width: 110px; z-index: 50; 
            display: none; transition: transform 0.2s linear; will-change: transform;
        }
        .thruster-flame {
            fill: #ff9900; filter: blur(2px);
            animation: flicker 0.1s infinite alternate;
        }
        @keyframes flicker { 0% { opacity: 0.8; transform: scaleX(1); } 100% { opacity: 1; transform: scaleX(1.4); } }
        .floating { animation: float 2s ease-in-out infinite; }
        @keyframes float { 0%, 100% { margin-bottom: 0px; } 50% { margin-bottom: 15px; } }

        /* --- GAME UI --- */
        .game-screen { 
            height: 280px; position: relative; background: #020617;
            background-image: radial-gradient(circle at bottom left, rgba(255, 0, 68, 0.15), transparent);
            overflow: hidden; display: flex; justify-content: center; align-items: center;
        }
        .multiplier { font-size: 4.5rem; font-weight: 900; z-index: 10; text-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .crashed { color: var(--error) !important; animation: shake 0.4s ease-in-out; }
        @keyframes shake { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        /* --- TOASTS --- */
        #win-toast, #error-toast, #info-toast, #limit-toast { 
            position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%) scale(0); 
            padding: 20px 30px; border-radius: 20px; text-align: center; z-index: 3000; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }
        #win-toast { background: rgba(10, 46, 26, 0.95); border: 2px solid var(--success); }
        #info-toast { background: rgba(10, 26, 46, 0.95); border: 2px solid var(--info); }
        #error-toast { background: rgba(46, 10, 10, 0.95); border: 2px solid var(--error); }
        
        /* STYLISH LIMIT TOAST */
        #limit-toast { 
            background: rgba(15, 23, 42, 0.98); 
            border: 2px solid var(--gold); 
            box-shadow: 0 0 30px rgba(255, 204, 0, 0.2);
            min-width: 200px;
        }

        .show-toast { transform: translate(-50%, -50%) scale(1) !important; }

        /* --- CONTROLS --- */
        .controls-footer { position: fixed; bottom: 0; width: 100%; background: #0b0f1a; padding: 15px 20px; border-top: 1px solid #1e293b; box-sizing: border-box; z-index: 1100; }
        .btn-main { width: 100%; padding: 18px; border-radius: 12px; border: none; font-size: 1.1rem; font-weight: 900; cursor: pointer; text-transform: uppercase; }
        .btn-bet { background: var(--success); color: #000; }
        .btn-cash { background: var(--gold); color: #000; }

        /* --- LISTS --- */
        .player-list { padding: 15px; background: var(--card); min-height: 100vh; padding-bottom: 350px; }
        .player-row { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #1f2937; font-size: 0.8rem; }
        .player-row.won { background: rgba(46, 204, 113, 0.1); color: var(--success); font-weight: bold; }

        /* Input Alert Animation */
        .bet-alert { animation: input-pulse 0.4s ease; border: 1px solid var(--gold) !important; }
        @keyframes input-pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        /* Custom Keypad */
        #custom-keypad { position: fixed; bottom: -100%; left: 0; width: 100%; background: #111827; transition: 0.3s; z-index: 5000; border-top: 2px solid var(--primary); padding-bottom: 20px; }
        .keypad-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 15px; }
        .key { background: #1f2937; padding: 15px; border-radius: 10px; text-align: center; font-size: 1.5rem; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<audio id="snd-countdown" src="assets/sounds/countdown.mp3" preload="auto"></audio>
<audio id="snd-flying" src="assets/sounds/flying.mp3" loop preload="auto"></audio>
<audio id="snd-crash" src="assets/sounds/crash.mp3" preload="auto"></audio>

<div id="win-toast"><div style="font-size:0.7rem; color:var(--success); font-weight:bold;">CASHOUT SUCCESS</div><h1 id="toast-mult" style="margin:5px 0; font-size:2.5rem;">2.50x</h1><h2 id="toast-amt" style="margin:0;">₦0.00</h2></div>
<div id="error-toast"><div id="error-msg" style="font-weight:bold;">Insufficient Balance</div></div>
<div id="info-toast"><div style="font-size:0.9rem; color:var(--info); font-weight:bold;">ROUND IN PROGRESS</div><div style="font-size:0.8rem; margin-top:5px;">Please wait for the next countdown to place your bet.</div></div>

<div id="limit-toast">
    <i class="fa-solid fa-triangle-exclamation" style="color:var(--gold); font-size:2rem; margin-bottom:10px;"></i>
    <div style="font-size:0.8rem; color:var(--gold); font-weight:bold; letter-spacing:1px;">LIMIT REACHED</div>
    <div id="limit-msg" style="font-size:1.1rem; margin-top:5px; font-weight:900;">Minimum Bet is ₦100</div>
</div>

<div class="game-container">
    <div class="top-nav" style="display:flex; justify-content:space-between; align-items:center; padding:10px; background:#000;">
        <a href="home.html" style="color:white; text-decoration:none; font-size:0.8rem; font-weight:bold;">⬅ BACK</a>
        <span style="font-weight: 900; color: var(--primary); font-size: 0.9rem;">AVIATOR GENIUS</span>
        <button id="mute-toggle" onclick="toggleMute()" style="background:none; border:none; color:#666; font-size:1.2rem;"><i class="fa-solid fa-volume-high"></i></button>
    </div>

    <div class="history-bar" id="history-container" style="display:flex; gap:8px; padding:10px; overflow-x:auto; background:#020617;"></div>

    <div class="game-screen">
        <div id="countdown-overlay">
            <div class="launch-ring"><div class="timer-val" id="timer-sec">5</div></div>
            <div style="margin-top:10px; font-weight:bold; font-size:0.6rem; letter-spacing:2px; color:var(--primary);">LAUNCHING SOON</div>
        </div>

        <div id="multiplier" class="multiplier">1.00x</div>

        <div id="plane-wrapper">
            <svg viewBox="0 0 100 50">
                <path class="thruster-flame" d="M10,25 L-12,18 L-5,25 L-12,32 Z" />
                <path d="M20,25 L40,15 L85,22 L98,25 L85,28 L40,35 Z" fill="#ff0044" />
                <path d="M45,25 L35,5 L60,25 L35,45 Z" fill="#cc0033" />
                <path d="M68,22 Q78,18 88,25 Q78,32 68,28 Z" fill="rgba(255,255,255,0.3)" />
            </svg>
        </div>
    </div>

    <div style="display:flex; justify-content:space-between; padding:10px; background:#111827; font-size:0.7rem; color:#666;">
        <span>ALL BETS</span>
        <span>LIVE USERS: <span id="bot-count" style="color:var(--success)">0</span></span>
    </div>
    <div class="player-list" id="player-list"></div>

    <div class="controls-footer">
        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.8rem;">
            <span>WALLET: <span id="bal-display" style="color: var(--success); font-weight: bold;">0.00</span></span>
            <div style="display:flex; align-items:center; gap:5px;">
                <span style="font-size:0.6rem; color:#888;">AUTO</span>
                <input type="checkbox" id="auto-toggle" onchange="toggleAutoUI()">
                <span id="auto-val-display" style="color:var(--gold); font-weight:bold;" onclick="openKeypad()">2.00x</span>
            </div>
        </div>
        <div style="display:flex; gap:10px; margin-bottom: 12px;">
             <button onclick="adjustBet(-500)" style="background:#2d3548; color:white; border:none; width:45px; border-radius:8px;">-</button>
             <input type="number" id="bet-amt" value="1000" style="flex:1; background:#1a1f2e; border:1px solid #333; color:white; text-align:center; font-weight:bold; border-radius:10px; font-size: 1.1rem;">
             <button onclick="adjustBet(500)" style="background:#2d3548; color:white; border:none; width:45px; border-radius:8px;">+</button>
        </div>
        <button id="action-btn" class="btn-main btn-bet" onclick="handleMainAction()">Place Bet</button>
    </div>
</div>

<div id="custom-keypad">
    <div style="display:flex; justify-content: space-between; padding: 15px; border-bottom: 1px solid #333;">
        <span style="font-size:0.8rem; color:#666;">SET AUTO CASH OUT</span>
        <span onclick="closeKeypad()" style="color:var(--primary); font-weight:bold;">DONE</span>
    </div>
    <div class="keypad-grid">
        <div class="key" onclick="kpIn('1')">1</div><div class="key" onclick="kpIn('2')">2</div><div class="key" onclick="kpIn('3')">3</div>
        <div class="key" onclick="kpIn('4')">4</div><div class="key" onclick="kpIn('5')">5</div><div class="key" onclick="kpIn('6')">6</div>
        <div class="key" onclick="kpIn('7')">7</div><div class="key" onclick="kpIn('8')">8</div><div class="key" onclick="kpIn('9')">9</div>
        <div class="key" onclick="kpIn('.')">.</div><div class="key" onclick="kpIn('0')">0</div><div class="key" onclick="kpDel()">DEL</div>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://aviatorlife-54828-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const gameRef = firebase.database().ref("live_game");

    let _supa, myEmail = localStorage.getItem('user_email'), balance = 0;
    let currentMult = 1.0, gameActive = false, isQueued = false, hasCashedOut = false;
    let lockedBet = 0, bots = [], lastKnownStatus = "", masterMute = false;
    let autoCashEnabled = false, autoCashValue = 2.00;

    window.onload = async () => {
        _supa = getClient();
        await fetchUserData();
        loadHistory();
        initFirebaseSync(); 
    };

    function initFirebaseSync() {
        gameRef.on("value", (snapshot) => {
            const data = snapshot.val();
            if(!data) return;
            if(data.status !== lastKnownStatus) {
                if(data.status === "WAITING") handleWaiting(data.countdown);
                if(data.status === "FLYING") startFlying();
                if(data.status === "CRASHED") handleCrashed(data.multiplier);
                lastKnownStatus = data.status;
            }
            if(data.status === "WAITING") {
                document.getElementById('timer-sec').innerText = Math.ceil(data.countdown);
            } else if (data.status === "FLYING") {
                handleFlyingState(data.multiplier);
            }
        });
    }

    function handleWaiting(timer) {
        gameActive = false; hasCashedOut = false;
        document.getElementById('multiplier').classList.remove('crashed');
        document.getElementById('countdown-overlay').style.display = 'flex';
        document.getElementById('plane-wrapper').style.display = "none";
        document.getElementById('multiplier').innerText = "1.00x";
        document.getElementById('snd-flying').pause();
        if(timer > 4.5 && !masterMute) document.getElementById('snd-countdown').play().catch(()=>{});
        if(bots.length === 0) generateBots(); 
        updateBtnUI();
    }

    async function startFlying() {
        gameActive = true;
        document.getElementById('countdown-overlay').style.display = 'none';
        document.getElementById('plane-wrapper').style.display = "block";
        if(!masterMute) document.getElementById('snd-flying').play().catch(()=>{});
        if(isQueued) await deductBalance(lockedBet);
    }

    function handleFlyingState(mult) {
        currentMult = parseFloat(mult);
        document.getElementById('multiplier').innerText = currentMult.toFixed(2) + "x";
        
        if(isQueued && !hasCashedOut && autoCashEnabled && currentMult >= autoCashValue) cashOut();

        bots.forEach(b => { if(!b.won && currentMult >= parseFloat(b.cashAt)) b.won = true; });
        renderPlayers();

        const plane = document.getElementById('plane-wrapper');
        let moveX = Math.min((currentMult - 1) * 35, 260);
        let moveY = Math.min((currentMult - 1) * 18, 160);
        plane.style.transform = `translate(${moveX}px, -${moveY}px)`;
        if (currentMult >= 2.0) plane.classList.add('floating');

        if(isQueued && !hasCashedOut) {
            document.getElementById('action-btn').innerText = `CASH OUT ₦${(lockedBet * currentMult).toFixed(2)}`;
            document.getElementById('action-btn').className = "btn-main btn-cash";
        }
    }

    function handleCrashed(finalMult) {
        gameActive = false;
        document.getElementById('snd-flying').pause();
        if(!masterMute) document.getElementById('snd-crash').play().catch(()=>{});
        
        const multDisplay = document.getElementById('multiplier');
        multDisplay.innerText = parseFloat(finalMult).toFixed(2) + "x";
        multDisplay.classList.add('crashed');
        
        const plane = document.getElementById('plane-wrapper');
        plane.style.transition = "transform 0.6s ease-in";
        plane.style.transform += " translate(300px, -150px)"; 

        setTimeout(() => { 
            plane.style.display = "none"; 
            plane.style.transition = "transform 0.2s linear";
            multDisplay.innerText = "FLEW AWAY";
        }, 700);

        isQueued = false; lockedBet = 0;
        updateBtnUI(); loadHistory(); bots = []; 
    }

    async function cashOut() {
        if(hasCashedOut || !isQueued || !gameActive) return;
        hasCashedOut = true;
        const win = lockedBet * currentMult;
        balance += win; 
        updateBalanceUI();
        
        document.getElementById('toast-mult').innerText = currentMult.toFixed(2) + "x";
        document.getElementById('toast-amt').innerText = "₦" + win.toLocaleString();
        document.getElementById('win-toast').classList.add('show-toast');
        
        await _supa.from('profiles').update({ balance }).eq('email', myEmail);
        setTimeout(() => document.getElementById('win-toast').classList.remove('show-toast'), 2500);
        updateBtnUI();
    }

    // UPDATED: DYNAMIC LIMIT TOAST
    function showLimitToast(type) {
        const toast = document.getElementById('limit-toast');
        const msg = document.getElementById('limit-msg');
        const input = document.getElementById('bet-amt');
        
        if (type === 'min') {
            msg.innerText = "Minimum Bet is ₦100";
        } else {
            msg.innerText = "Maximum Bet is ₦500,000";
        }

        toast.classList.add('show-toast');
        input.classList.add('bet-alert');
        setTimeout(() => {
            toast.classList.remove('show-toast');
            input.classList.remove('bet-alert');
        }, 3000);
    }

    function handleMainAction() {
        if (gameActive && !isQueued) {
            document.getElementById('info-toast').classList.add('show-toast');
            setTimeout(() => document.getElementById('info-toast').classList.remove('show-toast'), 3000);
            return;
        }

        if(!gameActive) {
            const betAmt = Number(document.getElementById('bet-amt').value);
            if (betAmt < 100) {
                showLimitToast('min');
                return;
            }
            if (betAmt > 500000) {
                showLimitToast('max');
                return;
            }
            if(!isQueued) {
                if(balance < betAmt) { showError("Insufficient Balance"); return; }
                lockedBet = betAmt; isQueued = true;
            } else { isQueued = false; lockedBet = 0; }
            updateBtnUI();
        } else if(!hasCashedOut && isQueued) cashOut();
    }

    async function deductBalance(amt) {
        balance -= amt; 
        updateBalanceUI();
        await _supa.from('profiles').update({ balance }).eq('email', myEmail);
    }

    function generateBots() {
        const count = Math.floor(Math.random() * 200) + 100;
        bots = Array.from({length: count}, () => ({
            id: `ID_${Math.floor(100 + Math.random() * 899)}***`,
            bet: Math.floor(Math.random() * 499000) + 1000,
            cashAt: (1.1 + Math.random() * 4).toFixed(2),
            won: false
        })).sort((a,b) => b.bet - a.bet);
        document.getElementById('bot-count').innerText = bots.length;
        renderPlayers();
    }

    function renderPlayers() {
        document.getElementById('player-list').innerHTML = bots.slice(0, 20).map(b => `
            <div class="player-row ${b.won ? 'won' : ''}">
                <div>${b.id}<br>₦${b.bet.toLocaleString()}</div>
                <div style="text-align:right">${b.won ? `${b.cashAt}x<br>₦${(b.bet*b.cashAt).toLocaleString()}` : '•••'}</div>
            </div>`).join('');
    }

    function updateBtnUI() {
        const btn = document.getElementById('action-btn');
        if(!gameActive) {
            btn.innerText = isQueued ? "CANCEL QUEUE" : "PLACE BET";
            btn.style.background = isQueued ? "#550011" : "var(--success)";
            btn.className = "btn-main btn-bet";
        }
    }

    function updateBalanceUI() { document.getElementById('bal-display').innerText = balance.toLocaleString(); }
    
    // UPDATED: ADJUST BET WITH BOTH LIMITS
    function adjustBet(val) { 
        let input = document.getElementById('bet-amt'); 
        let newVal = Number(input.value) + val;
        if (newVal < 100) {
            showLimitToast('min');
            input.value = 100;
        } else if (newVal > 500000) {
            showLimitToast('max');
            input.value = 500000;
        } else {
            input.value = newVal;
        }
    }

    function openKeypad() { document.getElementById('custom-keypad').style.bottom = '0'; }
    function closeKeypad() { document.getElementById('custom-keypad').style.bottom = '-100%'; }
    function kpIn(v) { 
        let d = document.getElementById('auto-val-display'); 
        let cur = d.innerText.replace('x','');
        d.innerText = (cur === '0' ? v : cur + v) + 'x';
        autoCashValue = parseFloat(d.innerText);
    }
    function kpDel() { 
        let d = document.getElementById('auto-val-display');
        d.innerText = (d.innerText.slice(0, -2) || '0') + 'x';
        autoCashValue = parseFloat(d.innerText);
    }
    function toggleAutoUI() { autoCashEnabled = document.getElementById('auto-toggle').checked; }
    function toggleMute() { masterMute = !masterMute; document.getElementById('mute-toggle').classList.toggle('active'); }
    async function fetchUserData() {
        const { data } = await _supa.from('profiles').select('balance').eq('email', myEmail).single();
        if(data) { balance = Number(data.balance); updateBalanceUI(); }
    }
    async function loadHistory() {
        const { data } = await _supa.from('game_logs').select('multiplier_cashed').order('created_at', {ascending: false}).limit(10);
        if(data) document.getElementById('history-container').innerHTML = data.map(h => `<div style="padding:4px 12px; background:#1a1a1a; border-radius:20px; font-size:0.7rem; font-weight:bold;">${Number(h.multiplier_cashed).toFixed(2)}x</div>`).join('');
    }
    function showError(m) { document.getElementById('error-msg').innerText = m; document.getElementById('error-toast').classList.add('show-toast'); setTimeout(()=>document.getElementById('error-toast').classList.remove('show-toast'), 3000); }
</script>
</body>
</html>
