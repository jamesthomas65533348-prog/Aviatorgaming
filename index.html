<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register - Aviator Genius</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <style>
        :root { --primary: #007bff; --bg: #0a0e17; }
        body { background: var(--bg); color: white; font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .card { background: rgba(255,255,255,0.05); padding: 25px; border-radius: 15px; width: 85%; max-width: 350px; border: 1px solid #222; text-align: center; }
        input { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: none; box-sizing: border-box; background: #fff; color: #000; }
        button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; margin-top: 10px; cursor: pointer; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 12px 20px; border-radius: 20px; display: none; z-index: 100; font-weight: bold; color: white; }
        @keyframes bounce { 0% { transform: translateX(-50%) scale(0.7); opacity: 0; } 100% { transform: translateX(-50%) scale(1); opacity: 1; } }
        .animate { display: block !important; animation: bounce 0.4s ease forwards; }
    </style>
</head>
<body>
    <div id="toast"></div>
    <div class="card">
        <h2 style="margin-bottom: 20px;">Aviator Genius</h2>
        <input type="email" id="email" placeholder="Email Address">
        <input type="password" id="pass" placeholder="Create Password">
        <input type="password" id="confirm_pass" placeholder="Confirm Password">
        <input type="number" id="nin" placeholder="NIN (11 Digits)">
        <button id="signup-btn" onclick="doSignUp()">Sign Up Now</button>
        <p style="font-size: 0.8rem; margin-top: 15px; opacity: 0.7;" onclick="location.href='login.html'">Already have an account? Login</p>
    </div>

    <script>
        // Function to generate the unique 16-character Profile Code
        function generateProfileCode() {
            var chars = "ABCDEFGHJKLMNPQRSTUVWXYZ234567890";
            var result = "";
            for (var i = 0; i < 16; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function showToast(msg, isSuccess) {
            var t = document.getElementById('toast');
            t.innerText = msg;
            t.style.background = isSuccess ? "#2ecc71" : "#ff4d4d";
            t.className = "animate";
            setTimeout(function(){ t.className = ""; t.style.display="none"; }, 3000);
        }

        async function doSignUp() {
            var email = document.getElementById('email').value.trim();
            var pass = document.getElementById('pass').value;
            var confirmPass = document.getElementById('confirm_pass').value;
            var nin = document.getElementById('nin').value;
            var btn = document.getElementById('signup-btn');
            
            // Ensure getClient() is defined in your config.js
            var _supa = getClient();

            // 1. Basic Validations
            if (!email || !pass || !nin) {
                showToast("Please fill all fields!", false);
                return;
            }
            if (pass !== confirmPass) {
                showToast("Passwords do not match!", false);
                return;
            }
            if (nin.length !== 11) {
                showToast("NIN must be 11 digits!", false);
                return;
            }

            btn.disabled = true;
            btn.innerText = "Verifying...";

            try {
                // 2. CHECK IF USER EXISTS AND STATUS
                const { data: existingUser, error: checkError } = await _supa
                    .from('profiles')
                    .select('email, otp_code')
                    .eq('email', email)
                    .maybeSingle();

                if (existingUser) {
                    if (existingUser.otp_code === 'PENDING') {
                        // User exists but hasn't finished OTP
                        localStorage.setItem('my_email', email);
                        showToast("Resuming registration...", true);
                        setTimeout(function(){ location.href='otp.html'; }, 2000);
                        return;
                    } else {
                        // User exists and is already verified
                        showToast("Email already registered. Please login.", false);
                        btn.disabled = false;
                        btn.innerText = "Sign Up Now";
                        return;
                    }
                }

                // 3. PROCEED WITH NEW SIGNUP
                btn.innerText = "Creating Account...";
                var myCode = generateProfileCode();
                localStorage.setItem('my_email', email);

                var { error: insertError } = await _supa.from('profiles').insert([
                    { 
                        email: email, 
                        password: pass, 
                        nin: nin, 
                        profile_code: myCode,
                        balance: 0,
                        otp_code: 'PENDING'
                    }
                ]);

                if (insertError) {
                    if(insertError.message.includes("unique")) {
                        showToast("Email already exists", false);
                    } else {
                        showToast("Error: " + insertError.message, false);
                    }
                    btn.disabled = false;
                    btn.innerText = "Sign Up Now";
                } else {
                    showToast("Success! Verify your OTP...", true);
                    setTimeout(function(){ location.href='otp.html'; }, 2000);
                }

            } catch (err) {
                console.error(err);
                showToast("Connection failed. Try again.", false);
                btn.disabled = false;
                btn.innerText = "Sign Up Now";
            }
        }
    </script>
</body>
</html>
